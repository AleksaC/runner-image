#!/usr/bin/env python3
import argparse
import os
import subprocess


def _push(
        *,
        tag: str,
        hostname: str,
        username: str,
        password: str,
        prefix: str,
) -> None:
    subprocess.run(
        (
            'docker', 'login', '--username', username, '--password-stdin',
            hostname,
        ),
        input=password.encode(),
        check=True,
    )

    tag_image, _, _ = tag.partition(':')
    for target_tag in (f'{prefix}/{tag}', f'{prefix}/{tag_image}:latest'):
        subprocess.check_call(('docker', 'tag', tag, target_tag))
        subprocess.check_call(('docker', 'push', target_tag))


def _inspect(tag: str) -> bytes:
    cmd = ('docker', 'image', 'inspect', tag, '--format', '{{.Id}}')
    return subprocess.check_output(cmd)


def main() -> int:
    parser = argparse.ArgumentParser()
    parser.add_argument('tag')
    args = parser.parse_args()

    push = _inspect(args.tag)
    target = _inspect('ghcr.io/pre-commit-ci/runner-image:latest')

    if push == target:
        print('skipping push (up to date)')
        return 0

    _push(
        tag=args.tag,
        hostname='docker.io',
        username='precommitci',
        password=os.environ['DOCKERHUB_TOKEN'],
        prefix='precommitci',
    )

    _push(
        tag=args.tag,
        hostname='ghcr.io',
        username='pre-commit-ci-bot',
        password=os.environ['GHCR_TOKEN'],
        prefix='ghcr.io/pre-commit-ci',
    )

    return 0


if __name__ == '__main__':
    exit(main())
